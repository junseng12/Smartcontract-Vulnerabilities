const hre = require("hardhat");

async function main() {
  //âž¡ï¸ Hardhatì€ getSigners()ì˜ ì²« ë²ˆì§¸ ê³„ì • (accounts[0]) ì„ ìžë™ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•´.
  // ì¦‰, ethers.getContractFactory()ê°€ ë¦¬í„´í•˜ëŠ” ì»¨íŠ¸ëž™íŠ¸ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ signers[0] (ì¦‰, ì²« ë²ˆì§¸ ê³„ì •)ê³¼ ì—°ê²°ë˜ì–´ ìžˆë‹¤
  const [deployer, attacker] = await hre.ethers.getSigners();

  console.log("ðŸš€ Deployer address:", deployer.address);
  console.log("ðŸŽ¯ Attacker address:", attacker.address);

  // Vulnerable ì»¨íŠ¸ëž™íŠ¸ ë°°í¬
  const Vulnerable = await hre.ethers.getContractFactory("Vulnerable");
  // ë°°í¬ íŠ¸ëžœìž­ì…˜ì„ ìƒì„±í•˜ê³ , ë„¤íŠ¸ì›Œí¬ì— ì „ì†¡í•¨
  // ì•„ì§ â€œë¸”ë¡ì— í™•ì •ë˜ì§€ ì•Šì€ ìƒíƒœâ€ë‹¤. ë”°ë¼ì„œ, vulnerableì€ ë°°í¬ ì¤€ë¹„ ì¤‘ì¸ ì»¨íŠ¸ëž™íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³´ë©´ ë¨
  // vulnerableì€ ì‹¤ì œ ë°°í¬ëœ ì»¨íŠ¸ëž™íŠ¸ì˜ ì£¼ì†Œ, í•¨ìˆ˜, ìƒíƒœ ë“± ëª¨ë“  ê¸°ëŠ¥ì„ ê°€ì§„ JS ê°ì²´ì•¼. ì´í›„ì— vulnerable.donate(), vulnerable.withdraw() ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìžˆì–´.
  // ë§ˆì¹˜ "ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ëž™íŠ¸ í´ëž˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤"ì²˜ëŸ¼ ì´ìš©í•˜ë©´ ë¨
  const vulnerable = await Vulnerable.deploy();
  //ê·¸ íŠ¸ëžœìž­ì…˜ì´ ì‹¤ì œë¡œ ë¸”ë¡ì— í¬í•¨ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  await vulnerable.waitForDeployment(); // âœ… ìµœì‹  Hardhatì—ì„œëŠ” deployed ëŒ€ì‹  ì´ê±¸ ì‚¬ìš©!
  // console.log("âœ… Vulnerable deployed at:", vulnerable.address);  ì•„ëž˜ì— ë” ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë°”ê¿ˆ
  const vulnerableAddress = await vulnerable.getAddress();
  console.log("âœ… Vulnerable deployed at:", vulnerableAddress);

  // ì´ˆê¸° ìžê¸ˆ ê³µê¸‰
  await deployer.sendTransaction({
    to: vulnerable.address,
    //ìµœì‹  Hardhatì—ì„œëŠ” ethers.utils.parseEther() ëŒ€ì‹  ethers.parseEther()ë¡œ ë°”ë€Œì—ˆì–´!
    //value: hre.ethers.utils.parseEther("5"),
    value: hre.ethers.parseEther("5"),
  });
  console.log("ðŸ’° Vulnerable funded with 5 ETH");

  // ê³µê²© ì»¨íŠ¸ëž™íŠ¸ ë°°í¬
  const Attack = await hre.ethers.getContractFactory("AttackReentrancy");
  // Connect() í•¨ìˆ˜:  "ëˆ„ê°€ ì´ íŠ¸ëžœìž­ì…˜ì„ ë³´ë‚´ëŠ”ê°€"ë¥¼ ì§€ì •í•˜ëŠ” ê²ƒ
  // Hardhatì˜ ì»¨íŠ¸ëž™íŠ¸ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë°°í¬ìž (deployer) ê³„ì •ìœ¼ë¡œ ì—°ê²°ë¼ ìžˆì–´.
  // í•˜ì§€ë§Œ ìš°ë¦¬ê°€ ì–´ë–¤ í•¨ìˆ˜ë‚˜ ë°°í¬ë¥¼ ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ í•˜ê³  ì‹¶ì„ ë•Œ, .connect()ë¥¼ ì¨ì„œ ì—°ê²°ì„ ë°”ê¾¸ëŠ” ê±°ì•¼.
  const attack = await Attack.connect(attacker).deploy(vulnerable.address);
  await attack.waitForDeployment();
  // console.log("âš”ï¸  Attack contract deployed at:", attack.address);
  console.log("âš”ï¸  Attack contract deployed at:", await attack.getAddress());

  // ê³µê²© ì‹¤í–‰
  const tx = await attack.connect(attacker).attack({
    // value: hre.ethers.utils.parseEther("1"),
    value: hre.ethers.parseEther("1"),
  });
  await tx.wait();
  console.log("ðŸ”¥ Attack executed");

  // ê²°ê³¼ í™•ì¸
  const attackerBalance = await hre.ethers.provider.getBalance(attack.address);
  console.log(
    "ðŸ“Š Attacker contract balance:",
    hre.ethers.utils.formatEther(attackerBalance),
    "ETH"
  );
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
