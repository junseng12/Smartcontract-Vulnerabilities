const hre = require("hardhat");

async function main() {
  //âž¡ï¸ Hardhatì€ getSigners()ì˜ ì²« ë²ˆì§¸ ê³„ì • (accounts[0]) ì„ ìžë™ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•´.
  // ì¦‰, ethers.getContractFactory()ê°€ ë¦¬í„´í•˜ëŠ” ì»¨íŠ¸ëž™íŠ¸ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ signers[0] (ì¦‰, ì²« ë²ˆì§¸ ê³„ì •)ê³¼ ì—°ê²°ë˜ì–´ ìžˆë‹¤
  const [deployer, attacker] = await hre.ethers.getSigners();

  console.log("ðŸš€ Deployer address:", deployer.address);
  console.log("ðŸŽ¯ Attacker address:", attacker.address);

  // Vulnerable ì»¨íŠ¸ëž™íŠ¸ ë°°í¬
  const Vulnerable = await hre.ethers.getContractFactory("Vulnerable");
  // ë°°í¬ íŠ¸ëžœìž­ì…˜ì„ ìƒì„±í•˜ê³ , ë„¤íŠ¸ì›Œí¬ì— ì „ì†¡í•¨
  // ì•„ì§ â€œë¸”ë¡ì— í™•ì •ë˜ì§€ ì•Šì€ ìƒíƒœâ€ë‹¤. ë”°ë¼ì„œ, vulnerableì€ ë°°í¬ ì¤€ë¹„ ì¤‘ì¸ ì»¨íŠ¸ëž™íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³´ë©´ ë¨
  // vulnerableì€ ì‹¤ì œ ë°°í¬ëœ ì»¨íŠ¸ëž™íŠ¸ì˜ ì£¼ì†Œ, í•¨ìˆ˜, ìƒíƒœ ë“± ëª¨ë“  ê¸°ëŠ¥ì„ ê°€ì§„ JS ê°ì²´ì•¼. ì´í›„ì— vulnerable.donate(), vulnerable.withdraw() ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìžˆì–´.
  // ë§ˆì¹˜ "ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ëž™íŠ¸ í´ëž˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤"ì²˜ëŸ¼ ì´ìš©í•˜ë©´ ë¨
  const vulnerable = await Vulnerable.deploy();
  //ê·¸ íŠ¸ëžœìž­ì…˜ì´ ì‹¤ì œë¡œ ë¸”ë¡ì— í¬í•¨ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  await vulnerable.waitForDeployment(); // âœ… ìµœì‹  Hardhatì—ì„œëŠ” deployed ëŒ€ì‹  ì´ê±¸ ì‚¬ìš©!
  // console.log("âœ… Vulnerable deployed at:", vulnerableAddress);  ì•„ëž˜ì— ë” ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë°”ê¿ˆ
  const vulnerableAddress = await vulnerable.getAddress();
  console.log("âœ… Vulnerable deployed at:", vulnerableAddress);

  // ì´ˆê¸° ìžê¸ˆ ê³µê¸‰
  await deployer.sendTransaction({
    to: vulnerableAddress,
    //ìµœì‹  Hardhatì—ì„œëŠ” ethers.utils.parseEther() ëŒ€ì‹  ethers.parseEther()ë¡œ ë°”ë€Œì—ˆì–´!
    //value: hre.ethers.utils.parseEther("5"),
    value: hre.ethers.parseEther("5"),
  });
  console.log("ðŸ’° Vulnerable funded with 5 ETH");

  // ê³µê²© ì»¨íŠ¸ëž™íŠ¸ ë°°í¬
  const Attack = await hre.ethers.getContractFactory("AttackReentrancy");
  // Connect() í•¨ìˆ˜:  "ëˆ„ê°€ ì´ íŠ¸ëžœìž­ì…˜ì„ ë³´ë‚´ëŠ”ê°€"ë¥¼ ì§€ì •í•˜ëŠ” ê²ƒ
  // Hardhatì˜ ì»¨íŠ¸ëž™íŠ¸ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë°°í¬ìž (deployer) ê³„ì •ìœ¼ë¡œ ì—°ê²°ë¼ ìžˆì–´.
  // í•˜ì§€ë§Œ ìš°ë¦¬ê°€ ì–´ë–¤ í•¨ìˆ˜ë‚˜ ë°°í¬ë¥¼ ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ í•˜ê³  ì‹¶ì„ ë•Œ, .connect()ë¥¼ ì¨ì„œ ì—°ê²°ì„ ë°”ê¾¸ëŠ” ê±°ì•¼.
  //deploy(vulnerableAddress) => ê³µê²© ëŒ€ìƒì¸ Vulnerable ì»¨íŠ¸ëž™íŠ¸ì˜ ì£¼ì†Œë¥¼ ìƒì„±ìž ë„˜ê²¨ì¤Œ
  const attack = await Attack.connect(attacker).deploy(vulnerableAddress);
  await attack.waitForDeployment();
  // console.log("âš”ï¸  Attack contract deployed at:", attack.address);
  console.log(
    "âš”ï¸  Attacker contract deployed at:",
    await attacker.getAddress()
  );

  // //ê³µê²©ìží•œí…Œ 100 ETHë§Œ ë‚¨ê²¨ë†“ê³  ê³µê²© ì‹œë®¬ë ˆì´ì…˜
  // const balance = await hre.ethers.provider.getBalance(attacker.address);
  // await attacker.sendTransaction({
  //   to: "0x000000000000000000000000000000000000dead", // dummy ì£¼ì†Œ
  //   value: balance - hre.ethers.parseEther("100"), // 100 ETHë§Œ ë‚¨ê¸°ê³  ë³´ë‚´ë²„ë¦¬ê¸°
  // });

  console.log(
    "ðŸ”¥ ê³µê²© ì‹œìž‘ ì „ Attack ì»¨íŠ¸ëž™íŠ¸ ìž”ì•¡:",
    hre.ethers.formatEther(
      await hre.ethers.provider.getBalance(attack.getAddress())
    )
  );

  console.log(
    "ðŸ”¥ ê³µê²© ì‹œìž‘ ì „ Attacker EOA ìž”ì•¡:",
    hre.ethers.formatEther(
      await hre.ethers.provider.getBalance(attacker.getAddress())
    )
  );

  //revertê°€ ë‚˜ë„ ì´í›„ì— balance ì¡°íšŒí•˜ê¸° ìœ„í•´ ê³µê²© ì‹¤í–‰ë¬¸ + ê²°ê³¼ í™•ì¸ë¬¸ tryCatchë¡œ ê°ì‹¸ê¸°
  try {
    // ê³µê²© ì‹¤í–‰
    const tx = await attack.connect(attacker).attack({
      // value: hre.ethers.utils.parseEther("1"),
      value: hre.ethers.parseEther("1"),
    });
    await tx.wait();
    // âœ… ì¶”ê°€: ìž”ì•¡ í™•ì¸
    const attackerEOABalanceAfter = await hre.ethers.provider.getBalance(
      attacker.address
    );
    const attackContractBalanceAfter = await hre.ethers.provider.getBalance(
      await attack.getAddress()
    );

    console.log(
      "ðŸ“Š ê³µê²© ì„±ê³µ í›„ Attacker EOA ìž”ì•¡:",
      hre.ethers.formatEther(attackerEOABalanceAfter)
    );
    console.log(
      "ðŸ“Š ê³µê²© ì„±ê³µ í›„ Attack ì»¨íŠ¸ëž™íŠ¸ ìž”ì•¡:",
      hre.ethers.formatEther(attackContractBalanceAfter)
    );
  } catch (e) {
    console.log("ðŸš¨ ê³µê²© ì¤‘ revert ë°œìƒ!");
    // ê²°ê³¼ í™•ì¸
    // const attackerBalance = await hre.ethers.provider.getBalance(
    //   attacker.getAddress()
    // );
    // console.log(
    //   "ðŸ“Š Attack contract balance:",
    //   hre.ethers.formatEther(attackerBalance),
    //   "ETH"
    // );

    console.log(
      "ðŸ“Š ê³µê²© ì‹¤íŒ¨ í›„ Attack ì»¨íŠ¸ëž™íŠ¸ ìž”ì•¡:",
      hre.ethers.formatEther(
        await hre.ethers.provider.getBalance(attack.getAddress())
      )
    );

    console.log(
      "ðŸ“Š ê³µê²© ì‹¤íŒ¨ í›„ Attacker EOA ìž”ì•¡:",
      hre.ethers.formatEther(
        await hre.ethers.provider.getBalance(attacker.getAddress())
      )
    );

    const finalVulnerableBalance = await hre.ethers.provider.getBalance(
      vulnerableAddress
    );
    const finalAttackBalance = await hre.ethers.provider.getBalance(
      await attack.getAddress()
    );
    const finalAttackerBalance = await hre.ethers.provider.getBalance(
      attacker.address
    );

    console.log(
      "ðŸ“¦ vulnerable ìµœì¢… ìž”ì•¡:",
      hre.ethers.formatEther(finalVulnerableBalance)
    );
    console.log(
      "ðŸª™ attack ì»¨íŠ¸ëž™íŠ¸ ìµœì¢… ìž”ì•¡:",
      hre.ethers.formatEther(finalAttackBalance)
    );
    console.log(
      "ðŸ§â€â™‚ï¸ attacker EOA ìµœì¢… ìž”ì•¡:",
      hre.ethers.formatEther(finalAttackerBalance)
    );
  }
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
